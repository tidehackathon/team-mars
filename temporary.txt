select 
	n,
	test_fail_propability_2022
from 
	(select 
		s1.name as n,
		(s1.cwix_2021_bad::float / nullif(s2.cwix_2021_all,0)) as test_fail_propability_2021,
		(s1.cwix_2022_bad::float / nullif(s2.cwix_2022_all,0)) as test_fail_propability_2022
	from
		(select 
			s1.name,
			count(case when s1.exercise_cycle = 'CWIX 2021' then 1 end) as CWIX_2021_bad,
			count(case when s1.exercise_cycle = 'CWIX 2022' then 1 end) as CWIX_2022_bad
		from 
			(select 
				s2.id,
				s1.name,
				s2.exercise_cycle,
				s2.overall_result
			from 
				(select 
					s.name,
					ts.testcase_id
				from 
					standards s 
				join
					testcase_standards ts 
				on
					s.id = ts.standard_id) s1
			join 
				(select 
					t.id,
					exercise_cycle,
					t.overall_result 
				from 
					testcases t 
				where 
					overall_result != 'Success' and not io_shortfall_ind) s2
			on
				s1.testcase_id = s2.id) s1
		join 
			(select
				tic.testcase_id,
				ic.name	
			from 
				issue_categories ic 
			join
				testcase_issue_categories tic 
			on
				ic.id = tic.issue_category_id 
			where 
				ic.id != 9 and ic.id != 12) s2
		on
			s1.id = s2.testcase_id
		group by 
			1) s1
	join	
		(select 
			s1.name,
			count(case when s1.exercise_cycle = 'CWIX 2021' then 1 end) as CWIX_2021_all,
			count(case when s1.exercise_cycle = 'CWIX 2022' then 1 end) as CWIX_2022_all
		from 
			(select 
				s2.id,
				s1.name,
				s2.exercise_cycle,
				s2.overall_result
			from 
				(select 
					s.name,
					ts.testcase_id
				from 
					standards s 
				join
					testcase_standards ts 
				on
					s.id = ts.standard_id) s1
			join 
				(select 
					t.id,
					exercise_cycle,
					t.overall_result 
				from 
					testcases t 
				where 
					not io_shortfall_ind) s2
			on
				s1.testcase_id = s2.id) s1
		join 
			(select
				tic.testcase_id,
				ic.name
			from 
				issue_categories ic 
			join
				testcase_issue_categories tic 
			on
				ic.id = tic.issue_category_id ) s2
		on
			s1.id = s2.testcase_id
		group by 
			1) s2 
	on
		s1.name = s2.name) s1
where
	test_fail_propability_2022 = 1
		
select 
	n,
	test_fail_propability_2021
from 
	(select 
		s1.name as n,
		(s1.cwix_2021_bad::float / nullif(s2.cwix_2021_all,0)) as test_fail_propability_2021,
		(s1.cwix_2022_bad::float / nullif(s2.cwix_2022_all,0)) as test_fail_propability_2022
	from
		(select 
			s1.name,
			count(case when s1.exercise_cycle = 'CWIX 2021' then 1 end) as CWIX_2021_bad,
			count(case when s1.exercise_cycle = 'CWIX 2022' then 1 end) as CWIX_2022_bad
		from 
			(select 
				s2.id,
				s1.name,
				s2.exercise_cycle,
				s2.overall_result
			from 
				(select 
					s.name,
					ts.testcase_id
				from 
					standards s 
				join
					testcase_standards ts 
				on
					s.id = ts.standard_id) s1
			join 
				(select 
					t.id,
					exercise_cycle,
					t.overall_result 
				from 
					testcases t 
				where 
					overall_result != 'Success' and not io_shortfall_ind) s2
			on
				s1.testcase_id = s2.id) s1
		join 
			(select
				tic.testcase_id,
				ic.name	
			from 
				issue_categories ic 
			join
				testcase_issue_categories tic 
			on
				ic.id = tic.issue_category_id 
			where 
				ic.id != 9 and ic.id != 12) s2
		on
			s1.id = s2.testcase_id
		group by 
			1) s1
	join	
		(select 
			s1.name,
			count(case when s1.exercise_cycle = 'CWIX 2021' then 1 end) as CWIX_2021_all,
			count(case when s1.exercise_cycle = 'CWIX 2022' then 1 end) as CWIX_2022_all
		from 
			(select 
				s2.id,
				s1.name,
				s2.exercise_cycle,
				s2.overall_result
			from 
				(select 
					s.name,
					ts.testcase_id
				from 
					standards s 
				join
					testcase_standards ts 
				on
					s.id = ts.standard_id) s1
			join 
				(select 
					t.id,
					exercise_cycle,
					t.overall_result 
				from 
					testcases t 
				where 
					not io_shortfall_ind) s2
			on
				s1.testcase_id = s2.id) s1
		join 
			(select
				tic.testcase_id,
				ic.name
			from 
				issue_categories ic 
			join
				testcase_issue_categories tic 
			on
				ic.id = tic.issue_category_id ) s2
		on
			s1.id = s2.testcase_id
		group by 
			1) s2 
	on
		s1.name = s2.name) s1
where 
	test_fail_propability_2021 = 1